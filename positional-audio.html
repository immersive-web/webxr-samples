<!doctype html>
<!--
Copyright 2017 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>

    <title>Positional Audio</title>

    <link href='css/common.css' rel='stylesheet'></link>

    <script src="https://cdn.rawgit.com/google/songbird/master/build/songbird.min.js"></script>

    <script src='js/third-party/gl-matrix-min.js'></script>
    <script src='js/third-party/tiny-gltf2.js'></script>

    <script src='js/third-party/wglu/wglu-program.js'></script>
    <script src='js/third-party/wglu/wglu-stats.js'></script>
    <script src='js/third-party/wglu/wglu-texture.js'></script>

    <script src='js/webvr-button.js'></script>
    <script src='js/webvr-scene.js'></script>
    <script src='js/webvr-scene-gltf.js'></script>
    <script src='js/webvr-samples-util.js'></script>
  </head>
  <body>
    <header>
      <details open>
        <summary>Positional Audio</summary>
        <p>
          This sample demonstrates playing audio that sounds as if it originates
          at a specific point in the space. Audio will begin playing when you
          enter VR.
        </p>
      </details>
    </header>
    <script>
      (function () {
      'use strict';

      const DEFAULT_HEIGHT = 1.6;

      // VR globals.
      let vrButton = null;
      let vrExclusiveFrameOfRef = null;
      let vrNonExclusiveFrameOfRef = null;

      // WebGL scene globals.
      let gl = null;
      let scene = new WebVRSceneGLTF('media/gltf/garage/garage.gltf');
      scene.standingStats(true);
      let translatedViewMat = mat4.create();
      let translatedPoseMat = mat4.create();

      // Audio scene globals
      let audioContext = new AudioContext();
      let songbird = new Songbird(audioContext);
      songbird.output.connect(audioContext.destination);

      // Rough room dimensions in meters (estimated from model in Blender.)
      let roomDimensions = {
        width : 6,
        height : 3,
        depth : 6
      };

      // Simplified view of the materials that make up the scene.
      let roomMaterials = {
        left : 'plywood-panel', // Garage walls
        right : 'plywood-panel',
        front : 'plywood-panel',
        back : 'metal', // To account for the garage door
        down : 'polished-concrete-or-tile', // garage floor
        up : 'wood-ceiling'
      };
      songbird.setRoomProperties(roomDimensions, roomMaterials);

      function createAudioSource(options) {
        let audioElement = document.createElement('audio');
        audioElement.src = options.url;
        audioElement.loop = true;

        // Create an AudioNode from the audio element.
        let audioElementSource = audioContext.createMediaElementSource(audioElement);

        // Create a Source, connect desired audio input to it.
        let source = songbird.createSource();
        audioElementSource.connect(source.input);

        let pos = options.position;
        source.setPosition(pos[0], pos[1], pos[2]);

        return new Promise((resolve, reject) => {
          audioElement.addEventListener('canplay', () => {
            resolve(audioElement);
          });

          audioElement.addEventListener('error', (err) => {
            reject(err);
          });
        });
      }

      let audioSources = [];

      function initVR() {
        vrButton = new VRDeviceButton({
          onRequestSession: onRequestSession,
          onEndSession: onEndSession
        });
        document.querySelector('header').appendChild(vrButton.domElement);

        if (navigator.vr) {
          navigator.vr.getDevices().then((devices) => {
            // Load multiple audio sources.
            Promise.all([
              createAudioSource({
                url: 'media/sound/drums.ogg',
                position: [0, DEFAULT_HEIGHT, 1],
              }),
              createAudioSource({
                url: 'media/sound/guitar.ogg',
                position: [-1, DEFAULT_HEIGHT, 0],
              }),
              createAudioSource({
                url: 'media/sound/perc.ogg',
                position: [1, DEFAULT_HEIGHT, 0],
              }),
            ]).then((sources) => {
              audioSources = sources;
              // Wait till the audio is loaded before enabling the VR button.
              for (let device of devices) {
                vrButton.addDevice(device);
              }
            });
            vrButton.setTitle('Loading Audio');

            if (!devices.length)
              return;

            let outputCanvas = document.createElement('canvas');
            let ctx = outputCanvas.getContext('vrpresent');

            devices[0].requestSession({ outputContext: ctx })
                .then((session) => {
                  document.body.appendChild(outputCanvas);
                  onSessionStarted(session);
                });
          });
        }
      }

      function onRequestSession(device) {
        device.requestSession({ exclusive: true }).then((session) => {
          vrButton.setSession(session);
          onSessionStarted(session);
        });

        for (let source of audioSources) {
          source.play();
        }
      }

      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);

        if (!gl) {
          gl = VRSamplesUtil.initWebGLContext({
            compatibleVrDevice: session.device
          });

          scene.setWebGLContext(gl);
        }

        session.baseLayer = new VRWebGLLayer(session, gl);

        session.requestFrameOfReference('stage').then((frameOfRef) => {
          if (session.exclusive) {
            vrExclusiveFrameOfRef = frameOfRef;
          } else {
            vrNonExclusiveFrameOfRef = frameOfRef;
          }
          session.requestFrame(onVRFrame);
        });
      }

      function onEndSession(session) {
        session.end();
      }

      function onSessionEnded(event) {
        console.log('onSessionEnded');
        console.log('Session: ' + event.session);
        console.log('Exclusive: ' + event.session.exclusive);
        if (event.session.exclusive) {
          console.log('vrButton.setSession(null)');
          vrButton.setSession(null);

          // Stop the audio playback when we exit VR.
          console.log('Stop Audio');
          for (let source of audioSources) {
            source.pause();
          }
        }
      }

      function onVRFrame(frame) {
        let session = frame.session;
        let frameOfRef = session.exclusive ?
                         vrExclusiveFrameOfRef :
                         vrNonExclusiveFrameOfRef;
        let pose = frame.getDevicePose(frameOfRef);

        scene.startFrame();

        session.requestFrame(onVRFrame);

        scene.drawVRFrame(frame, pose);

        if (pose) {
          songbird.setListenerFromMatrix({ elements: pose.poseModelMatrix });
        }

        scene.endFrame();
      }

      // Start the VR application.
      initVR();
      })();
    </script>
  </body>
</html>
