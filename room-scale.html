<!doctype html>
<!--
Copyright 2017 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>

    <title>Room Scale</title>

    <link href='css/common.css' rel='stylesheet'></link>

    <script src='js/third-party/gl-matrix-min.js'></script>
    <script src='js/third-party/tiny-gltf2.js'></script>

    <script src='js/third-party/wglu/wglu-program.js'></script>
    <script src='js/third-party/wglu/wglu-stats.js'></script>
    <script src='js/third-party/wglu/wglu-texture.js'></script>

    <script src='js/webvr-button.js'></script>
    <script src='js/webvr-scene.js'></script>
    <script src='js/webvr-scene-gltf.js'></script>
    <script src='js/webvr-samples-util.js'></script>
  </head>
  <body>
    <header>
      <details open>
        <summary>Room Scale</summary>
        <p>
          This sample demonstrates using a 'stage' frame of reference to provide
          room scale tracking.
        </p>
      </summary>
    </header>
    <script>
      (function () {
      'use strict';

      // VR globals.
      let vrButton = null;
      let vrExclusiveFrameOfRef = null;
      let vrNonExclusiveFrameOfRef = null;

      // WebGL scene globals.
      let gl = null;
      let scene = new WebVRSceneGLTF('media/gltf/Camp/WebVRCampsite.gltf');
      scene.standingStats(true); // Position the stats at standing height.
      let translatedViewMat = mat4.create();

      const DEFAULT_HEIGHT = 1.65;

      function initVR() {
        vrButton = new VRDeviceButton({
          onRequestSession: onRequestSession,
          onEndSession: onEndSession
        });
        document.querySelector('header').appendChild(vrButton.domElement);

        if (navigator.vr) {
          navigator.vr.getDevices().then((devices) => {
            for (let device of devices) {
              vrButton.addDevice(device);
            }

            if (!devices.length)
              return;

            let outputCanvas = document.createElement('canvas');
            let ctx = outputCanvas.getContext('vrpresent');

            devices[0].requestSession({outputContext: ctx})
                .then((session) => {
                  document.body.appendChild(outputCanvas);
                  onSessionStarted(session);
                });
          });
        }
      }

      function onRequestSession(device) {
        device.requestSession({exclusive: true}).then((session) => {
          vrButton.setSession(session);
          onSessionStarted(session);
        });
      }

      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);

        if (!gl) {
          gl = VRSamplesUtil.initWebGLContext({
            compatibleVrDevice: session.device
          });

          scene.setWebGLContext(gl);
        }

        session.baseLayer = new VRWebGLLayer(session, gl);

        // Get a stage frame of reference, which will align the user's physical
        // floor with Y=0 and can provide boundaries that indicate where the
        // user can safely walk. In this case if the system can't natively
        // provide stage coordinates (for example, with a 3DoF device) then we
        // indicate that we are OK allowing an emulated stage, where the view
        // is translated up by a static height so that the scene still renders
        // in approximately the right place.
        session.requestFrameOfReference('stage', {stageEmulationAllowed: true})
            .then((frameOfRef) => {
              if (session.exclusive) {
                vrExclusiveFrameOfRef = frameOfRef;
              } else {
                vrNonExclusiveFrameOfRef = frameOfRef;
              }
              session.requestFrame(onVRFrame);
            });
      }

      function onEndSession(session) {
        session.end();
      }

      function onSessionEnded(event) {
        if (event.session.exclusive)
          vrButton.setSession(null);
      }

      function onVRFrame(frame) {
        let session = frame.session;
        let frameOfRef = session.exclusive ?
                         vrExclusiveFrameOfRef :
                         vrNonExclusiveFrameOfRef;
        let pose = frame.getDevicePose(frameOfRef);

        scene.startFrame();

        session.requestFrame(onVRFrame);

        // Every VR frame uses basically the same render loop, so for the sake
        // of keeping the sample code focused on the interesting bits most
        // samples after this one will start using this helper function to hide
        // away the majority of the rendering logic.
        scene.drawVRFrame(frame, pose);

        scene.endFrame();
      }

      // Start the VR application.
      initVR();
      })();
    </script>
  </body>
</html>
